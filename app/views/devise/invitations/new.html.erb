<% content_for :title, "Create new user" %>
<% content_for :breadcrumbs,
   render("govuk_publishing_components/components/breadcrumbs", {
     collapse_on_mobile: true,
     breadcrumbs: [
       {
         title: "Home",
         url: root_path,
       },
       {
         title: "Users",
         url: users_path,
       },
       {
         title: "Create new user",
       }
     ]
   })
%>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <%= form_for resource, as: resource_name, url: invitation_path(resource_name), html: { method: :post } do |f| %>
      <% if f.object.errors.any? %>
        <%= render "govuk_publishing_components/components/error_summary", {
          id: "error-summary",
          title: "There was a problem with your new user",
          items: f.object.errors.map do |error|
            {
              text: error.full_message,
              href: "#user_#{error.attribute}",
            }
          end
        } %>
      <% end %>

      <%= render "govuk_publishing_components/components/input", {
        label: { text: "Name" },
        name: "user[name]",
        id: "user_name",
        error_items: f.object.errors.full_messages_for(:name).map { |message| { text: message } },
        value: f.object.name,
        autocomplete: "off",
      } %>

      <%= render "govuk_publishing_components/components/input", {
        label: { text: "Email" },
        name: "user[email]",
        id: "user_email",
        error_items: f.object.errors.full_messages_for(:email).map { |message| { text: message } },
        value: f.object.email,
        autocomplete: "off",
      } %>

      <%= render "govuk_publishing_components/components/select", {
        id: "user_organisation_id",
        name: "user[organisation_id]",
        label: "Organisation",
        options: options_for_organisation_select(selected: f.object.organisation_id)
      } %>

      <% if policy(User).assign_role? %>
        <% role_hint = capture do %>
          <%= render "govuk_publishing_components/components/list", {
            visible_counters: true,
            items: [
              "<strong>Superadmins</strong> can create and edit all user types and edit applications.",
              "<strong>Admins</strong> can create and edit normal users.",
              "<strong>Super Organisation Admins</strong> can unlock and unsuspend their organisation and related organisation accounts.",
              "<strong>Organisation Admins</strong> can unlock and unsuspend their organisation accounts.",
            ]
          } %>
        <% end %>

        <%= render "govuk_publishing_components/components/select", {
          id: "user_role",
          name: "user[role]",
          label: "Role",
          hint: role_hint,
          options: options_for_role_select(selected: f.object.role),
        } %>
      <% end %>

      <%= render "govuk_publishing_components/components/fieldset", {
        legend_text: "Permissions",
        heading_size: "l",
      } do %>

        <% policy_scope(:user_permission_manageable_application).reject(&:retired?).map do |application| %>
          <%= render("govuk_publishing_components/components/option_select", {
            title: application.name,
            key: "not-used",
            options_container_id: "user_application_#{application.id}_supported_permissions",
            options: options_for_permission_option_select(application:, user: f.object),
          }) %>
        <% end %>

      <% end %>

      <div class="govuk-button-group">
        <%= render "govuk_publishing_components/components/button", {
          text: "Create user and send email",
        } %>

        <%= link_to "Cancel", users_path, class: "govuk-link govuk-link--no-visited-state" %>
      </div>
    <% end %>
  </div>
</div>
