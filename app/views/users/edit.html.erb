<% content_for :title, "Edit #{@user.name}" %>

<h1>Edit <%= @user.name %></h1>

<section>
  <h2>User details</h2>
  <dl>
    <div>
      <dt>Status</dt>
      <dd><%= status(@user) %></dd>
      <dd></dd>
    </div>
  </dl>
</section>

<section>
  <h2>Actions</h2>
  <ul>
    <li><%= link_to "Account access log", event_logs_user_path(@user) %></li>
    <% if policy(@user).suspension? %>
      <li><%= link_to @user.suspended? ? "Unsuspend user" : "Suspend user", edit_suspension_path(@user) %></li>
    <% end %>
  </ul>
</section>

<% if @user.invited_but_not_yet_accepted? %>
  <div class="alert alert-warning">
    <strong>Invitation not accepted yet</strong>.<br/>
    This user hasn't clicked on the link in their signup mail yet.

    <% if policy(@user).resend_invitation? %>
      <p>
        <%= link_to "Resend signup email", edit_user_invitation_resend_path(@user) %>
      </p>
    <% end %>
  </div>
<% end %>

<% if @user.access_locked? %>
  <div class="alert alert-warning">
    <strong>Account has been locked after too many unsuccessful login attempts.</strong><br/>
    Locked accounts are automatically unlocked after <%= User.unlock_in.inspect %>.

    <% if policy(@user).unlock? %>
      <p>
        <%= link_to "Unlock account", edit_user_unlocking_path(@user) %>
      </p>
    <% end %>
  </div>
<% end %>

<% if @user.suspended? and @user.reason_for_suspension.present? %>
  <p class="alert alert-warning">
    <strong>User suspended:</strong> <em><%= @user.reason_for_suspension %></em>
  </p>
<% end %>

<p>
  <strong>Name:</strong> <%= @user.name %>
  <%= link_to edit_user_name_path(@user) do %>
    Change<span class="invisible"> name</span>
  <% end %>
</p>

<p>
  <strong>Email:</strong> <%= @user.email %>
  <%= link_to edit_user_email_path(@user) do %>
    Change<span class="invisible"> email</span>
  <% end %>
</p>

<p>
  <strong>Role:</strong> <%= @user.role.humanize %>
  <% if policy(@user).assign_role? %>
    <%= link_to edit_user_role_path(@user) do %>
      Change<span class="invisible"> role</span>
    <% end %>
  <% end %>
</p>

<p>
  <strong>Organisation:</strong> <%= @user.organisation.present? ? @user.organisation.name : Organisation::NONE %>
  <% if policy(@user).assign_organisation? %>
    <%= link_to edit_user_organisation_path(@user) do %>
      Change<span class="invisible"> organisation</span>
    <% end %>
  <% end %>
</p>

<dl>
  <dt>Account security</dt>
  <dd>
    <% if @user.exempt_from_2sv? %>
      <p>
        The user has been made exempt from 2-step verification for the following reason: <%= @user.reason_for_2sv_exemption %>
        <% if policy(@user).exempt_from_two_step_verification? %>
          <br>
          <%= link_to 'Edit reason or expiry date for 2-step verification exemption', edit_two_step_verification_exemption_path(@user) %>
        <% end %>
      </p>
    <% elsif @user.has_2sv? %>
      <p>2-step verification enabled</p>
      <% if policy(@user).reset_2sv? %>
        <p>
          <%= link_to 'Reset 2-step verification', edit_user_two_step_verification_reset_path(@user) %>
        </p>
      <% end %>
    <% elsif @user.require_2sv? %>
      <p>2-step verification required but not set up</p>
    <% else %>
      <p>2-step verification not set up</p>
    <% end %>

    <% unless @user.require_2sv? %>
      <% if policy(@user).mandate_2sv? %>
        <p>
          <%= link_to(
            "Mandate 2-step verification for this user#{@user.exempt_from_2sv? ? ' (this will remove their exemption)' : nil}",
            edit_user_two_step_verification_mandation_path(@user)
          ) %>
        </p>
      <% end %>
    <% end %>

    <% if policy(@user).exempt_from_two_step_verification? && !@user.exempt_from_2sv? %>
      <p>
        <%= link_to 'Exempt user from 2-step verification', edit_two_step_verification_exemption_path(@user) %>
        <br/>
        Exempt a user from 2-step verification (requires a reason to be supplied).
      </p>
    <% end %>
  </dd>
</dl>

<p>
  <%= link_to "Manage permissions", manage_permissions_user_path(@user) %>
</p>
