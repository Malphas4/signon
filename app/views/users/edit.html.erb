<% content_for :title, "Edit [#{@user.name}]" %>

<h1>Edit &ldquo;<%= @user.name %>&rdquo;</h1>

<p class="suspenders">
  User <strong><%= @user.status %></strong> &bull;
  <%= link_to "Account access log", event_logs_user_path(@user) %> &bull;
  <%= link_to "#{@user.suspended? ? "Uns" : "S"}uspend user", edit_suspension_path(@user) %>
</p>

<% if policy(@user).resend_invitation? %>
  <% if @user.invited_but_not_yet_accepted? %>
    <div class="alert alert-warning">
      <strong>Invitation not accepted yet</strong>.<br/>
      This user hasn't clicked on the link in their signup mail yet.

      <p>
        <%= link_to "Resend signup email", edit_user_invitation_resend_path(@user) %>
      </p>
    </div>
  <% end %>
<% end %>

<% if policy(@user).unlock? %>
  <% if @user.access_locked? %>
    <div class="alert alert-warning">
      <strong>Account has been locked after too many unsuccessful login attempts.</strong><br/>
      Locked accounts are automatically unlocked after <%= User.unlock_in.inspect %>.

      <p>
        <%= link_to "Unlock account", edit_user_unlocking_path(@user) %>
      </p>
    </div>
  <% end %>
<% end %>

<% if @user.suspended? and @user.reason_for_suspension.present? %>
  <p class="alert alert-warning">
    <strong>User suspended:</strong> <em><%= @user.reason_for_suspension %></em>
  </p>
<% end %>

<p>
  <strong>Name:</strong> <%= @user.name %>
  <%= link_to edit_user_name_path(@user) do %>
    Change<span class="invisible"> name</span>
  <% end %>
</p>

<p>
  <strong>Email:</strong> <%= @user.email %>
  <%= link_to edit_user_email_path(@user) do %>
    Change<span class="invisible"> email</span>
  <% end %>
</p>

<p>
  <strong>Role:</strong> <%= @user.role.humanize %>
  <% if policy(User).assign_role? %>
    <%= link_to edit_user_role_path(@user) do %>
      Change<span class="invisible"> role</span>
    <% end %>
  <% end %>
</p>

<p>
  <strong>Organisation:</strong> <%= @user.organisation.present? ? @user.organisation.name : Organisation::NONE %>
  <% if policy(User).assign_organisation? %>
    <%= link_to edit_user_organisation_path(@user) do %>
      Change<span class="invisible"> organisation</span>
    <% end %>
  <% end %>
</p>

<dl>
  <dt>Account security</dt>
  <dd>
    <% if @user.exempt_from_2sv? %>
      <p>
        The user has been made exempt from 2-step verification for the following reason: <%= @user.reason_for_2sv_exemption %>
        <% if policy(@user).exempt_from_two_step_verification? %>
          <br>
          <%= link_to 'Edit reason or expiry date for 2-step verification exemption', edit_two_step_verification_exemption_path(@user) %>
        <% end %>
      </p>
    <% elsif @user.has_2sv? %>
      <p>2-step verification enabled</p>
      <p>
        <%= link_to 'Reset 2-step verification', edit_user_two_step_verification_reset_path(@user) %>
      </p>
    <% elsif @user.require_2sv? %>
      <p>2-step verification required but not set up</p>
    <% else %>
      <p>2-step verification not set up</p>
    <% end %>

    <% unless @user.require_2sv? %>
      <% if policy(@user).mandate_2sv? %>
        <p>
          <%= link_to(
            "Mandate 2-step verification for this user#{@user.exempt_from_2sv? ? ' (this will remove their exemption)' : nil}",
            edit_user_two_step_verification_mandation_path(@user)
          ) %>
        </p>
      <% end %>
    <% end %>

    <% if policy(@user).exempt_from_two_step_verification? && !@user.exempt_from_2sv? %>
      <p>
        <%= link_to 'Exempt user from 2-step verification', edit_two_step_verification_exemption_path(@user) %>
        <br/>
        Exempt a user from 2-step verification (requires a reason to be supplied).
      </p>
    <% end %>
  </dd>
</dl>

<% if @user.errors.count > 0 %>
  <div class="govuk-error-summary alert alert-danger" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="error-summary">
    <div class="govuk-error-summary__body">
      <ul class="govuk-list govuk-error-summary__list">
        <% @user.errors.full_messages.each do |message| %>
          <%= content_tag :li, message %>
        <% end %>
      </ul>
    </div>
  </div>
<% end %>

<%= form_for @user, :html => {:class => 'well add-top-margin'} do |f| %>
  <h2 class="add-vertical-margins"> <%= "Editable " if (current_user.publishing_manager? ) %>Permissions</h2>
  <%= render partial: "shared/user_permissions", locals: { user_object: @user }%>

  <% if current_user.publishing_manager? %>
    <h2 class="add-vertical-margins">All Permissions for this user</h2>
    <%= render partial: "app_permissions", locals: { user_object: @user }%>
  <% end %>

  <hr>

  <%= f.submit :class => 'btn btn-primary' %>
<% end %>
