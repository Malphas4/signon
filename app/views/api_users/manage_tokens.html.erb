<% content_for :title, "Manage tokens for #{@api_user.name}" %>

<ol class="breadcrumb">
  <li><%= link_to "Dashboard", root_path %></li>
  <li><%= link_to "API users", api_users_path %></li>
  <li><%= link_to @api_user.name, edit_api_user_path(@api_user) %></li>
  <li class="active">Manage tokens</li>
</ol>

<h1>Manage tokens for API User <%= @api_user.name %></h1>

<% if authorisation = flash[:authorisation] %>
  <div class="alert alert-danger">
    Make sure to copy the access token for <%= authorisation["application_name"] %> now. You won't be able to see it again!
  </div>
  <div class="alert alert-info">
    Access token for <%= authorisation["application_name"] %>: <span id='access-token'><%= authorisation["token"] %></span>
    <%= link_to 'Copy to clipboard', '#', class: 'btn btn-info add-left-margin', data: { 'clipboard-target' => 'access-token' }, id: 'clip-button', title: 'Click to copy access token' %>
  </div>
<% end %>
<table id="authorisations" class="table table-bordered table-on-white">
  <thead>
    <tr class="table-header">
      <th>Application</th>
      <th>Token (hidden)</th>
      <th>Generated</th>
      <th>Expires</th>
      <th>State</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <% @api_user.authorisations.not_revoked.ordered_by_application_name.ordered_by_expires_at.each do |authorisation| %>
      <tr>
        <td><%= authorisation.application.name %></td>
        <td><code><%= truncate_access_token(authorisation.token) %></code></td>
        <td>
          <%= authorisation.created_at.to_date.to_fs(:govuk_date) %>
        </td>
        <td>
          <%= authorisation.expires_at.to_date.to_fs(:govuk_date) %>
        </td>
        <td>
          <% if authorisation.expired? %>
            <span class="label label-danger">Expired</span>
          <% else %>
            <span class="label label-success">Valid</span>
          <% end %>
        </td>
        <td>
          <%= link_to "Revoke", edit_api_user_authorisation_path(@api_user, authorisation) %>
        </td>
    <% end %>
  </tbody>
</table>
<p>
  <%= link_to new_api_user_authorisation_path(@api_user), class: "btn btn-default" do %>
    <span class="glyphicon glyphicon-plus glyphicon-smaller-than-text"></span> Add application token
  <% end %>
</p>

<script>
  $(document).ready(function() {
    new ZeroClipboard($("#clip-button"));
  });
</script>
